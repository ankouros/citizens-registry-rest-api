## Δοχειοποίηση Εφαρμογών (Application Containerisation)

## 1. Εισαγωγή

Σκοπός της παρούσας εργασίας είναι η δοχειοποίηση (containerisation) του backend της εφαρμογής **Citizen Registry REST API**, η οποία είχε αναπτυχθεί στο πλαίσιο προηγούμενων ασκήσεων του προγράμματος.
Η εργασία υλοποιείται με τη χρήση του **Docker** και του **Docker Compose** και περιλαμβάνει:

* δοχειοποίηση της RESTful υπηρεσίας,
* χρήση δοχείου για το υποκείμενο Σύστημα Διαχείρισης Βάσεων Δεδομένων (ΣΔΒΔ),
* διαχείριση της διάταξης (deployment) μέσω scripts και docker-compose,
* εφαρμογή βασικών καλών πρακτικών ασφάλειας.

## 2. Δομή του έργου

Το έργο είναι **multi-module Maven project** και αποτελείται από τα ακόλουθα βασικά modules:

* `citizen-domain`: κοινό domain model (POJOs)
* `citizen-service`: RESTful backend υπηρεσία (**δοχειοποιείται**)
* `citizen-client`: client εφαρμογή
* `citizen-it`: integration tests

Η δοχειοποίηση αφορά **αποκλειστικά το module `citizen-service`**, καθώς αυτό αποτελεί το backend της εφαρμογής.

Όλα τα αρχεία της παρούσας άσκησης βρίσκονται στον φάκελο:

```
docker/
```

## 3. Dockerfile – Δοχειοποίηση RESTful Υπηρεσίας

Για τη δοχειοποίηση της RESTful υπηρεσίας χρησιμοποιείται **multi-stage Dockerfile**.

### Βασικά χαρακτηριστικά:

* Χρήση **Maven image** για το build στάδιο.
* Υποστήριξη **multi-module Maven build** (συμπεριλαμβάνεται το `citizen-domain`).
* Χρήση **JRE image** στο runtime στάδιο.
* Εκτέλεση εφαρμογής με **μη ριζικό χρήστη**.
* Μικρότερο τελικό μέγεθος εικόνας και μειωμένη επιφάνεια επιθέσεων.

Το Dockerfile βρίσκεται στο:

```
docker/Dockerfile
```

### Διόρθωση pom.xml για εκτελέσιμο JAR

Κατά τη δοκιμή του Docker image εμφανίστηκε σφάλμα `no main manifest attribute`,
που υποδεικνύει ότι το JAR δεν έχει επανασυσκευαστεί ως Spring Boot executable.
Για τον λόγο αυτό προστέθηκε στο `citizen-service/pom.xml` ο στόχος
`repackage` του `spring-boot-maven-plugin`, ώστε το τελικό JAR να είναι εκτελέσιμο
και να εκκινεί σωστά στο container.

## 4. Scripts Διαχείρισης Docker

### 4.1 build.sh

Το script:

* κατασκευάζει την εικόνα Docker της RESTful υπηρεσίας,
* δημιουργεί Docker volume για επίμονη αποθήκευση δεδομένων της βάσης.

### 4.2 startup.sh

Το script:

* δημιουργεί οριζόμενο Docker network,
* εκκινεί δοχείο MySQL από επίσημη εικόνα του Docker Hub,
* εκκινεί δοχείο της RESTful υπηρεσίας,
* επιτρέπει την επικοινωνία των δοχείων μέσω του Docker network,
* εκθέτει **μόνο** τη θύρα της RESTful υπηρεσίας στο τοπικό σύστημα.

Η επικοινωνία με τη βάση δεδομένων γίνεται μέσω του **ονόματος του δοχείου** (`mysql-db`) και όχι μέσω `localhost`.

### 4.3 shutdown.sh

Το script:

* σταματά και καταστρέφει τα δοχεία,
* αφαιρεί το Docker network,
* **δεν διαγράφει το volume**, ώστε τα δεδομένα της βάσης να παραμένουν διαθέσιμα.

## 5. Docker Compose – Μοντέλο Αρχιτεκτονικής Διάταξης

Η διάταξη της εφαρμογής περιγράφεται μέσω του αρχείου:

```
docker/docker-compose.yml
```

### Περιλαμβάνει:

* Υπηρεσία `citizen-service` (REST API)
* Υπηρεσία `db` (MySQL)
* Οριζόμενο Docker network
* Docker volume για επίμονη αποθήκευση δεδομένων

### Εφαρμοζόμενες καλές πρακτικές ασφάλειας:

* Η βάση δεδομένων **δεν εκθέτει θύρες** στο τοπικό σύστημα.
* Η RESTful υπηρεσία εκτελείται με **read-only filesystem**.
* Χρήση `no-new-privileges`.
* Χρήση επίσημης και αξιόπιστης εικόνας MySQL.

Η διάταξη εκτελείται με:

```bash
docker compose up -d
```

και τερματίζεται με:

```bash
docker compose down
```

## 6. Επίμονη Αποθήκευση Δεδομένων

Για το ΣΔΒΔ χρησιμοποιείται Docker volume:

```
citizen-db-data
```

Το volume αντιστοιχίζεται στον φάκελο:

```
/var/lib/mysql
```

Με αυτόν τον τρόπο:

* τα δεδομένα της βάσης διατηρούνται μετά από επανεκκίνηση δοχείων,
* είναι δυνατή η επαναχρησιμοποίηση της βάσης σε νέες εκτελέσεις.
